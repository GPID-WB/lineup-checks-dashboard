---
title: "Lineup Checks"
output:
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: yeti
    orientation: columns
    social: menu
    vertical_layout: scroll
runtime: shiny
---


```{r global, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(purrr)
library(fst)
library(joyn)
library(fastverse)
library(shiny)

source("R/utils.R")
pl <- 2.15

# Aggregates
dt_agg_old <- pipr::get_wb(povline = pl) |>
  qDT()
dt_agg_new <- load_from_repo("aggregates.fst")
dt_agg_old <- dt_agg_old |>
  frename(reporting_year = year)

# Survey years
dt_survey_old <- pipr::get_stats(povline = pl) |>
  qDT()
dt_survey_new <- load_from_repo("syears.fst")
dt_survey_old <- dt_survey_old |>
  frename(reporting_year = year)

# aggregates
dt_lineup_old <- pipr::get_stats(povline = pl,
                                 fill_gaps = TRUE) |>
  qDT()
dt_lineup_old <- dt_lineup_old |>
  frename(reporting_year = year)
dt_lineup_new <- load_from_repo("lyears.fst")


# survey data ---------------------
# Indicator names
survey_indicators    <- dt_survey_new |>
  fselect(headcount:decile10, spl, spr) |>
  colnames()


# Merging OLD and NEW data
surveys_merged <- joyn::joyn(
  x             = dt_survey_new,
  y             = dt_survey_old,
  by            = c(
    "country_code",
    "reporting_year",
    "welfare_type",
    "poverty_line",
    "reporting_level"
  ),
  match_type    = "1:1",
  keep          = "full",
  update_values = FALSE,
  all           = FALSE,
  verbose       = FALSE,
  y_vars_to_keep = TRUE,
  suffixes = c(".x", ".y"),
  keep_common_vars = TRUE
)

names_x <- paste0(survey_indicators, ".x")
names_y <- paste0(survey_indicators, ".y")

# Calculate the differences and assign them to new columns
surveys_merged[,
               (paste0(survey_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
surveys_merged[,
               (paste0(survey_indicators, "_perc")) := map2(mget(paste0(survey_indicators, "_diff")),
                                                            mget(names_y), `/`)]
# Ratio
surveys_merged[,
               (paste0(survey_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]

# Line up year -------------
# Indicator names
lineup_indicators    <- dt_lineup_new |>
  fselect(headcount:decile10, spl, spr) |>
  colnames()


# Merging OLD and NEW data
lineups_merged <- joyn::joyn(
  x             = dt_lineup_new,
  y             = dt_lineup_old,
  by            = c(
    "country_code",
    "reporting_year",
    "welfare_type",
    "poverty_line",
    "reporting_level"
  ),
  match_type    = "1:1",
  keep          = "full",
  update_values = FALSE,
  all           = FALSE,
  verbose       = FALSE,
  y_vars_to_keep = TRUE,
  suffixes = c(".x", ".y"),
  keep_common_vars = TRUE
)

names_x <- paste0(lineup_indicators, ".x")
names_y <- paste0(lineup_indicators, ".y")

# if zero, reassign to being very small
lineups_merged[,
               (paste0(names_x)) := lapply(.SD,
                                           function(x) {
                                             pmax(x, 0.000001)
                                           }),
               .SDcols = names_x]
lineups_merged[,
               (paste0(names_y)) := lapply(.SD,
                                           function(x) {
                                             pmax(x, 0.000001)
                                           }),
               .SDcols = names_y]


# Calculate the differences and assign them to new columns
lineups_merged[,
               (paste0(lineup_indicators, "_diff")) :=
                 map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
lineups_merged[,
               (paste0(lineup_indicators, "_perc")) :=
                 map2(mget(paste0(lineup_indicators, "_diff")),
                      mget(names_y), `/`)]
# Ratio
lineups_merged[,
               (paste0(lineup_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


# Outlier
amnt <- 2 # SD
lineups_merged[,
               (paste0(lineup_indicators, "_thresh_low")) :=
                 lapply(.SD,
                        function(x) {
                          mn <- mean(x, na.rm = T, trim = 0.01)
                          s  <-
                            sd(x[x > quantile(x,
                                              0.01,
                                              na.rm = T) &
                                   x < quantile(x,
                                                0.99,
                                                na.rm = T)],
                               na.rm = T)
                          mn - amnt * s
                        }),
               .SDcols = paste0(lineup_indicators, "_ratio")]

lineups_merged[,
               (paste0(lineup_indicators, "_thresh_high")) :=
                 lapply(.SD,
                        function(x) {
                          mn <- mean(x, na.rm = T, trim = 0.01)
                          s  <-
                            sd(x[x > quantile(x,
                                              0.01,
                                              na.rm = T) &
                                   x < quantile(x,
                                                0.99,
                                                na.rm = T)],
                               na.rm = T)
                          mn + amnt * s
                        }),
               .SDcols = paste0(lineup_indicators, "_ratio")]


```


Trends: Old vs New
===========================================================


Column {.sidebar}
-----------------------------------------------------------------------
```{r sidebar-plot-trends-123}
# Select Indicator
selectInput("trends_indicator", 
            label = "Compare indicator",
            choices = survey_indicators,
            selected = "mean")


# Select countries
selectInput("trend_country",
            label = "Economies",
            choices = c(surveys_merged$country_code |> funique()),
            selected = "ARE",
            multiple = FALSE)
```

```{r trends-reactive}
ind <- reactive({
  input$trends_indicator
})
# country 
ct <- reactive({
  input$trend_country
})
# reactive table for trends
ST <- reactive({
  surveys_merged[country_code == ct()
                 ][, 
                   `:=`(
                       yx = get(paste0(ind(), ".x")),
                       yy = get(paste0(ind(), ".y"))
                     ) ][, 
                         text :=  paste0(
                        "Economy: ", country_code, "\n",
                        "Region: ", region_name.x, "\n",
                        "New Value:", round(yx, 4), "\n",
                        "Old Value:", round(yy, 4), "\n",
                        "Year: ", reporting_year)
                        ] 
})

LT <- reactive({
  lineups_merged[country_code == ct()
                 ][, 
                   `:=`(
                       yx = get(paste0(ind(), ".x")),
                       yy = get(paste0(ind(), ".y"))
                     ) ][, 
                         text :=  paste0(
                        "Economy: ", country_code, "\n",
                        "Region: ", region_name.x, "\n",
                        "New Value:", round(yx, 4), "\n",
                        "Old Value:", round(yy, 4), "\n",
                        "Year: ", reporting_year)
                        ] 
})
```

Column
-----------------------------------------------------------------------

### Survey Years

```{r trends-svy}
renderPlotly({

  g_trends(dt = ST(), country = ct(), indicator = ind())

})
```

Column
-----------------------------------------------------------------------

### Lineups

```{r trends-lny}
renderPlotly({
  
  g_trends(dt = LT(), country = ct(), indicator = ind())
  
})
```



