---
title: "Lineup Checks"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    theme: paper
    vertical_layout: scroll
    runtime: shiny
---


```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)
library(collapse)
library(fst)
library(joyn)
library(data.table)
library(purrr)
library(RColorBrewer)
```


```{r}
source("R/utils.R")
pl <- 2.15

# Aggregates
dt_agg_old <- pipr::get_wb(povline = pl) |> 
  qDT()
dt_agg_new <- load_from_repo("aggregates.fst") 
dt_agg_old <- dt_agg_old |> 
  frename(reporting_year = year)

# Survey years
dt_survey_old <- pipr::get_stats(povline = pl) |> 
  qDT()
dt_survey_new <- load_from_repo("syears.fst") 
dt_survey_old <- dt_survey_old |> 
  frename(reporting_year = year)

# aggregates
dt_lineup_old <- pipr::get_stats(povline = pl, 
                                 fill_gaps = TRUE) |> 
  qDT()
dt_lineup_old <- dt_lineup_old |> 
  frename(reporting_year = year)
dt_lineup_new <- load_from_repo("lyears.fst") 
```


```{r survey-data-wrangling}
# Indicator names
survey_indicators    <- dt_survey_new |> 
  fselect(headcount:decile10, spl, spr) |> 
  colnames()


# Merging OLD and NEW data
surveys_merged <- joyn::joyn(x             = dt_survey_new,
                              y             = dt_survey_old,
                              by            = c("country_code",
                                                "reporting_year",
                                                "welfare_type",
                                                "poverty_line",
                                                "reporting_level"),
                              match_type    = "1:1",
                              keep          = "full",
                              update_values = FALSE,
                              all           = FALSE,
                              verbose       = FALSE,
                              y_vars_to_keep = TRUE,
                              suffixes = c(".x", ".y"),
                              keep_common_vars = TRUE)

names_x <- paste0(survey_indicators, ".x")
names_y <- paste0(survey_indicators, ".y")

# Calculate the differences and assign them to new columns
surveys_merged[, 
               (paste0(survey_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
surveys_merged[, 
               (paste0(survey_indicators, "_perc")) := map2(mget(paste0(survey_indicators, "_diff")), 
                                                            mget(names_y), `/`)]
# Ratio
surveys_merged[, 
               (paste0(survey_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


```



```{r lineup-data-wrangling}
# Indicator names
lineup_indicators    <- dt_lineup_new |> 
  fselect(headcount:decile10, spl, spr) |> 
  colnames()


# Merging OLD and NEW data
lineups_merged <- joyn::joyn(x             = dt_lineup_new,
                              y             = dt_lineup_old,
                              by            = c("country_code",
                                                "reporting_year",
                                                "welfare_type",
                                                "poverty_line",
                                                "reporting_level"),
                              match_type    = "1:1",
                              keep          = "full",
                              update_values = FALSE,
                              all           = FALSE,
                              verbose       = FALSE,
                              y_vars_to_keep = TRUE,
                              suffixes = c(".x", ".y"),
                              keep_common_vars = TRUE)

names_x <- paste0(lineup_indicators, ".x")
names_y <- paste0(lineup_indicators, ".y")

# if zero, reassign to being very small
lineups_merged[, 
   (paste0(names_x)) := lapply(.SD, 
                               function(x) {pmax(x, 0.000001)}), 
   .SDcols = names_x]
lineups_merged[, 
   (paste0(names_y)) := lapply(.SD, 
                               function(x) {pmax(x, 0.000001)}), 
   .SDcols = names_y]


# Calculate the differences and assign them to new columns
lineups_merged[, 
               (paste0(lineup_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
lineups_merged[, 
               (paste0(lineup_indicators, "_perc")) := map2(mget(paste0(lineup_indicators, "_diff")), 
                                                            mget(names_y), `/`)]
# Ratio
lineups_merged[, 
               (paste0(lineup_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


# Outlier
amnt <- 2 # SD


lineups_merged[, 
   (paste0(lineup_indicators, "_thresh_low")) := lapply(.SD, 
                                          function(x) {mean(x, na.rm = TRUE) - amnt*sd(x, na.rm = TRUE)}), 
   .SDcols = paste0(lineup_indicators, "_ratio")]

lineups_merged[, 
   (paste0(lineup_indicators, "_thresh_high")) := lapply(.SD, 
                                          function(x) {mean(x, na.rm = TRUE) - amnt*sd(x, na.rm = TRUE)}), 
   .SDcols = paste0(lineup_indicators, "_ratio")]




# 
# lineups_merged[,
#                (paste0(lineup_indicators, "_thresh_low")) := (mean(lineups_merged$new_old, na.rm = TRUE) -
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE),
#                       thres_new_old_hi = mean(lineups_merged$new_old, na.rm = TRUE) +
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE))]
# 
# 
# 
# lineups_merged[,
#                  `:=`(thres_new_old_lo = mean(lineups_merged$new_old, na.rm = TRUE) -
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE),
#                       thres_new_old_hi = mean(lineups_merged$new_old, na.rm = TRUE) +
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE))]

#
#   if (input$lineup_outlier_yes == "Yes") {
#       lineup_indicator[,
#                  new_old_out := !(new_old < thres_new_old_hi &
#                                     new_old > thres_new_old_lo)]
#   } else {
#           lineup_indicator[,
#                  new_old_out := (new_old < thres_new_old_hi &
#                                     new_old > thres_new_old_lo)]
#   }
#
#   lineup_indicator <- lineup_indicator[new_old_out == TRUE]
#
#   lineup_indicator <- lineup_indicator |>
#     fmutate(New = get(paste0(ind, ".x"))*100) |>
#     fmutate(Old = get(paste0(ind, ".y"))*100) |>
#     fselect("country_code", "reporting_year", "welfare_type", "Old", "New")
#
#   setnames(lineup_indicator,
#            old = c("Old", "New"),
#            new = c(paste0(c("Old_", "New_"), ind)))
# 
#  lineup_indicator
```



Survey years
===========================================================


Column {data-width=650}
-----------------------------------------------------------------------


```{r}
# Load and prepare the OLD survey estimates
dt_survey_old_samuel <- dt_survey_old

# Load and prepare the NEW survey estimates
dt_survey_new_samuel <- dt_survey_new
survey_indicators    <- dt_survey_new |> fselect(headcount:decile10, spl, spr) |> colnames()
# Merging OLD and NEW data 
surveys_merged <- joyn::joyn(x             = dt_survey_new_samuel, 
                              y             = dt_survey_old_samuel, 
                              by            = c("country_code", 
                                                "reporting_year", 
                                                "welfare_type", 
                                                "poverty_line", 
                                                "reporting_level"), 
                              match_type    = "1:1",
                              keep          = "full", 
                              update_values = FALSE,
                              all           = FALSE, 
                              verbose       = FALSE, 
                              y_vars_to_keep = TRUE, 
                              suffixes = c(".x", ".y"), 
                              keep_common_vars = TRUE)
```



Column {data-width=100}
-----------------------------------------------------------------------
```{r sidebar-plot-survey-3}
# Select Indicator
selectInput("survey_indicator", 
            label = "Compare indicator:",
            choices = survey_indicators,
            selected = "headcount")

# Select countries
selectInput("survey_country", 
            label = "Economies:",
            choices = c("All", surveys_merged$country_code |> funique()),
            selected = "COL", 
            multiple = TRUE)


# Select countries
selectInput("survey_percentage", 
            label = "Percentage (i.t.o old) or real difference:",
            choices = c("Percentage change", "Real difference", "Ratio"),
            selected = "Percentage", 
            multiple = FALSE)


# Select countries
numericInput(
  "survey_outlier",
  label = "Outlier detection - sd threshold",
  value = 2,
  min   = 0,
  max   = 5,
  step = 0.1,
  width = NULL
)

selectInput(
  "survey_outlier_yes", 
  label = "Is outlier", 
  choices = c("Yes", "No"), 
  selected = "Yes", 
  multiple = FALSE
)

```

```{r survey-data-reactive}
survey_indicator <- reactive({
  
  # Copy data table
  survey_indicator <- surveys_merged
  ind <- paste(input$survey_indicator)
  
  if (!input$survey_percentage == "Ratio") {
    # indicator
    survey_indicator <- survey_indicator |> 
      fmutate(New_minus_old = get(paste0(ind, ".x")) - 
                        get(paste0(ind, ".y")))
    

    
    if (input$survey_percentage == "Percentage") {
      survey_indicator <- survey_indicator |> 
        fmutate(New_minus_old = 100*New_minus_old/get(paste0(ind, ".y")))
    }
  } else {
      survey_indicator <- survey_indicator |> 
          fmutate(New_minus_old = get(paste0(ind, ".x"))/get(paste0(ind, ".y")))
  }
  
  if (!"All" %chin% input$survey_country) {
    survey_indicator <- survey_indicator |> 
      fsubset(country_code %in% input$survey_country)
  }
  
  # Tooltip
  survey_indicator[
    , 
    text_tooltip := 
      paste0(
        "Economy: ", country_code, "\n",
        "Region: ", region_name.x, "\n", 
        "Value: ", round(New_minus_old, 4), "\n", 
        "Year: ", reporting_year 
        
      )
  ]
  
  survey_indicator
  
})

survey_baltman <- reactive({
  
  # Copy data table
  survey_indicator <- surveys_merged
  ind <- paste(input$survey_indicator)
  
  if (!"All" %chin% input$survey_country) {
    survey_indicator <- survey_indicator |> 
      fsubset(country_code %in% input$survey_country)
  }
  survey_indicator[, 
                 `:=`(diff = get(paste0(ind, ".x")) - 
                        get(paste0(ind, ".y")),
                      mean_btw = (get(paste0(ind, ".x")) +
                        get(paste0(ind, ".y")))/2)]
  # Tooltip
  survey_indicator[
    , 
    text_tooltip := 
      paste0(
        "Economy: ", country_code, "\n",
        "Region: ", region_name.x, "\n", 
        "Mean old and new: ", round(mean_btw, 4), "\n", 
        "Difference: ", round(diff, 4), "\n", 
        "Year: ", reporting_year 
      )
  ]
  survey_indicator
  
})

survey_outlier <- reactive({
  amnt <- input$survey_outlier
  # Copy data table
  survey_indicator <- surveys_merged
  ind <- paste(input$survey_indicator)
  
  # 
  surveys_merged[, new_old := get(paste0(ind, ".x")) / get(paste0(ind, ".y"))]
  surveys_merged[, 
                 `:=`(thres_new_old_lo = mean(surveys_merged$new_old, na.rm = TRUE) - 
                          amnt * sd(surveys_merged$new_old, na.rm = TRUE),
                      thres_new_old_hi = mean(surveys_merged$new_old, na.rm = TRUE) + 
                          amnt * sd(surveys_merged$new_old, na.rm = TRUE))]
  

  if (input$survey_outlier_yes == "Yes") {
      surveys_merged[, 
                 new_old_out := !(new_old < thres_new_old_hi & 
                                    new_old > thres_new_old_lo)]
  } else {
          surveys_merged[, 
                 new_old_out := (new_old < thres_new_old_hi & 
                                    new_old > thres_new_old_lo)]
  }

  surveys_merged <- surveys_merged[new_old_out == TRUE]
  
  surveys_merged <- surveys_merged |> 
    fmutate(New = get(paste0(ind, ".x"))*100) |> 
    fmutate(Old = get(paste0(ind, ".y"))*100) |>
    fselect("country_code", "reporting_year", "welfare_type", "Old", "New") 
 
  setnames(surveys_merged, 
           old = c("Old", "New"), 
           new = c(paste0(c("Old_", "New_"), ind)))
  
  surveys_merged

  
})

```



Column {data-width=2400}
-----------------------------------------------------------------------

### Chart A


```{r plot-survey}
renderPlotly({
  dt <- survey_indicator()
  g <- ggplot(data = dt, aes(x      = reporting_year, 
                             y      = New_minus_old, 
                             colour = region_code.x, 
                             group  = country_code)) +
          geom_point(aes(text = text_tooltip)) +
          geom_line() +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "New survey estimate minus old", 
         x     = "Reporting Year", 
         y     = paste0("Difference in ",
                        input$survey_indicator,
                        ifelse(input$survey_percentage == "Percentage", " %", ""),
                        " (new minus old)"))
  
  g <- ggplotly(g, tooltip = "text")
  
  g

})

```

### Scatterplot of old vs new estimates

```{r}
renderPlotly({
  dt  <- survey_indicator()
  ind <- input$survey_indicator 
  
  g <- ggplot(data = dt, 
              aes(x = get(paste0(ind, ".y")), 
                  y = get(paste0(ind, ".x")), 
                  color = region_code.x, 
                  group = country_code)) +
    geom_point(aes(text = text_tooltip)) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", alpha = 0.3) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Scatter plot new survey estimate minus old", 
         x     = paste("Old", ind), 
         y     = paste("New", ind))
  
  g <- ggplotly(g, tooltip = "text")
  
  g
})
```


### Bland-Altman plot

```{r}
renderPlotly({
  dt  <- survey_baltman()
  ind <- input$survey_indicator
  
  g <- ggplot(data = dt, 
              aes(x = mean_btw, 
                  y = diff, 
                  color = region_code.x)) +
        geom_point(aes(text = text_tooltip)) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Bland-Altman Plot", 
         x     = paste("Mean of old and new", ind), 
         y     = paste("Difference between old and new", ind))
  
  g <- ggplotly(g, tooltip = "text")
  
  g
})
```








### Table of outliers


```{r}
renderTable({
  survey_outlier()
})

```





Lineup years
===========================================================







<!-- ```{r} -->
<!-- # Load and prepare the OLD lineup estimates -->
<!-- dt_lineup_old_samuel <- dt_lineup_old -->

<!-- # Load and prepare the NEW lineup estimates -->
<!-- dt_lineup_new_samuel <- dt_lineup_new -->
<!-- lineup_indicators    <- dt_lineup_new |> fselect(headcount:decile10, spl, spr) |> colnames() -->
<!-- # Merging OLD and NEW data -->
<!-- lineups_merged <- joyn::joyn(x             = dt_lineup_new_samuel, -->
<!--                               y             = dt_lineup_old_samuel, -->
<!--                               by            = c("country_code", -->
<!--                                                 "reporting_year", -->
<!--                                                 "welfare_type", -->
<!--                                                 "poverty_line", -->
<!--                                                 "reporting_level"), -->
<!--                               match_type    = "1:1", -->
<!--                               keep          = "full", -->
<!--                               update_values = FALSE, -->
<!--                               all           = FALSE, -->
<!--                               verbose       = FALSE, -->
<!--                               y_vars_to_keep = TRUE, -->
<!--                               suffixes = c(".x", ".y"), -->
<!--                               keep_common_vars = TRUE) -->
<!-- ``` -->



Column {data-width=100}
-----------------------------------------------------------------------
```{r sidebar-plot-lineup-3}
# Select Indicator
selectInput("lineup_indicator",
            label = "Compare indicator:",
            choices = lineup_indicators,
            selected = "headcount")

# Select countries
selectInput("lineup_country",
            label = "Economies:",
            choices = c("All", lineups_merged$country_code |> funique()),
            selected = "COL",
            multiple = TRUE)


# Select countries
selectInput("lineup_percentage",
            label = "Percentage (i.t.o old) or real difference:",
            choices = c("Percentage change", "Real difference", "Ratio"),
            selected = "Percentage change",
            multiple = FALSE)


# Select countries
numericInput(
  "lineup_outlier",
  label = "Outlier detection - sd threshold",
  value = 2,
  min   = 0,
  max   = 5,
  step = 0.1,
  width = NULL
)

selectInput(
  "lineup_outlier_yes",
  label = "Is outlier",
  choices = c("Yes", "No"),
  selected = "Yes",
  multiple = FALSE
)

```





```{r lineup-data-reactive}


lineup_indicator <- reactive({
  lineups_merged <- copy(lineups_merged)
  # # Copy data table
  # lineup_indicator <- lineups_merged
  ind <- paste(input$lineup_indicator)
  # 
  # if (!input$lineup_percentage == "Ratio") {
  #   # indicator
  #   lineup_indicator <- lineup_indicator |>
  #     fmutate(New_minus_old = get(paste0(ind, ".x")) -
  #                       get(paste0(ind, ".y")))
  # 
  # 
  # 
  #   if (input$lineup_percentage == "Percentage") {
  #     lineup_indicator <- lineup_indicator |>
  #       fmutate(New_minus_old = 100*New_minus_old/get(paste0(ind, ".y")))
  #   }
  # } else {
  #     lineup_indicator <- lineup_indicator |>
  #         fmutate(New_minus_old = get(paste0(ind, ".x"))/get(paste0(ind, ".y")))
  # } 

  if (!"All" %chin% input$lineup_country) {
    lineups_merged <- lineups_merged |>
      fsubset(country_code %in% input$lineup_country)
  }
  
  if (input$lineup_percentage == "Ratio") {
    ind <- paste0(ind, "_ratio")
  } else if (input$lineup_percentage == "Percentage change") {
    ind <- paste0(ind, "_perc")
  } else if (input$lineup_percentage == "Real difference") {
    ind <- paste0(ind, "_diff")
  }
  
  setnames(lineups_merged, 
           old = ind, 
           new = "Indicator")
  

  # Tooltip
  lineups_merged[
    ,
    text_tooltip :=
      paste0(
        "Economy: ", country_code, "\n",
        "Region: ", region_name.x, "\n",
        "Value: ", round(Indicator, 4), "\n",
        "Year: ", reporting_year

      )
  ]

  lineups_merged

})



lineup_baltman <- reactive({

  # Copy data table
  lineup_indicator <- lineups_merged
  ind <- paste(input$lineup_indicator)

  if (!"All" %chin% input$lineup_country) {
    lineup_indicator <- lineup_indicator |>
      fsubset(country_code %in% input$lineup_country)
  }
  lineup_indicator[,
                 `:=`(diff = get(paste0(ind, ".x")) -
                        get(paste0(ind, ".y")),
                      mean_btw = (get(paste0(ind, ".x")) +
                        get(paste0(ind, ".y")))/2)]
  # Tooltip
  lineup_indicator[
    ,
    text_tooltip :=
      paste0(
        "Economy: ", country_code, "\n",
        "Region: ", region_name.x, "\n",
        "Mean old and new: ", round(mean_btw, 4), "\n",
        "Difference: ", round(diff, 4), "\n",
        "Year: ", reporting_year
      )
  ]
  lineup_indicator

})


lineup_outlier <- reactive({

  # amnt <- input$lineup_outlier
  # # Copy data table
  # lineup_indicator <- lineups_merged
  # 
  ind <- paste(input$lineup_indicator)
  
  # #
  # lineup_indicator[, new_old := get(paste0(ind, ".x")) / get(paste0(ind, ".y"))]
  # lineup_indicator[,
  #                `:=`(thres_new_old_lo = mean(lineups_merged$new_old, na.rm = TRUE) -
  #                         amnt * sd(lineups_merged$new_old, na.rm = TRUE),
  #                     thres_new_old_hi = mean(lineups_merged$new_old, na.rm = TRUE) +
  #                         amnt * sd(lineups_merged$new_old, na.rm = TRUE))]
#return()

if (input$lineup_outlier_yes == "Yes") {
    lineups_merged[,
               new_old_out := !(get(paste0(ind, "_ratio")) < get(paste0(ind, "_thresh_high")) &
                                  get(paste0(ind, "_ratio")) > get(paste0(ind, "_thresh_low")))]
} else {
    lineups_merged[,
               new_old_out := (get(paste0(ind, "_ratio")) < get(paste0(ind, "_thresh_high")) &
                                  get(paste0(ind, "_ratio")) > get(paste0(ind, "_thresh_low")))]
}

lineups_merged <- lineups_merged[new_old_out == TRUE]

lineups_merged <- lineups_merged |>
  fmutate(New = get(paste0(ind, ".x"))*100) |>
  fmutate(Old = get(paste0(ind, ".y"))*100) |>
  fselect("country_code", "reporting_year", "welfare_type", "Old", "New")

setnames(lineups_merged,
         old = c("Old", "New"),
         new = c(paste0(c("Old_", "New_"), ind)))

lineups_merged

})

```



Column {data-width=2400}
-----------------------------------------------------------------------

### Chart A


```{r plot-lineup}
renderPlotly({
  dt <- lineup_indicator()
  g <- ggplot(data = dt, aes(x      = reporting_year,
                             y      = Indicator,
                             colour = region_code.x,
                             group  = country_code)) +
          geom_point(aes(text = text_tooltip)) +
          geom_line() +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "New lineup estimate minus old",
         x     = "Reporting Year",
         y     = paste0("Difference in ",
                        input$lineup_indicator,
                        ifelse(input$lineup_percentage == "Percentage", " %", ""),
                        " (new minus old)"))

  g <- ggplotly(g, tooltip = "text")

  g

})

```

### Scatterplot of old vs new estimates

```{r}
renderPlotly({
  dt  <- lineup_indicator()
  ind <- input$lineup_indicator

  g <- ggplot(data = dt,
              aes(x = get(paste0(ind, ".y")),
                  y = get(paste0(ind, ".x")),
                  color = region_code.x,
                  group = country_code)) +
    geom_point(aes(text = text_tooltip)) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", alpha = 0.3) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Scatter plot new lineup estimate minus old",
         x     = paste("Old", ind),
         y     = paste("New", ind))

  g <- ggplotly(g, tooltip = "text")

  g
  
})
```


### Bland-Altman plot



```{r}
renderPlotly({
  dt  <- lineup_baltman()
  ind <- input$lineup_indicator

  g <- ggplot(data = dt,
              aes(x = mean_btw,
                  y = diff,
                  color = region_code.x)) +
        geom_point(aes(text = text_tooltip)) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Bland-Altman Plot",
         x     = paste("Mean of old and new", ind),
         y     = paste("Difference between old and new", ind))

  g <- ggplotly(g, tooltip = "text")

  g
})
```








### Table of outliers


```{r}
renderTable({
  lineup_outlier()
})

```









