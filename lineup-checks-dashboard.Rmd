---
title: "Lineup Checks"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    theme: paper
    vertical_layout: scroll
    runtime: shiny
#     resource_files:
#     - data/use/dt_survey_old.fst
#     - data/use/dt_survey_new.fst
#     - data/use/dt_lineup_old.fst
#     - data/use/dt_lineup_new.fst
#     - data/use/dt_agg_old.fst
#     - data/use/dt_agg_new.fst
# resource_files:
# - data/use/dt_survey_old.fst
# - data/use/dt_survey_new.fst
# - data/use/dt_lineup_old.fst
# - data/use/dt_lineup_new.fst
# - data/use/dt_agg_old.fst
# - data/use/dt_agg_new.fst
---



```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(joyn)
library(purrr)
library(fst)
library(fastverse)
library(shiny)
```


```{r global, include=FALSE}
source("R/utils.R")
pl <- 2.15

# Aggregates
dt_agg_old <- pipr::get_wb(povline = pl) |>
  qDT()
dt_agg_new <- load_from_repo("aggregates.fst")
dt_agg_old <- dt_agg_old |>
  frename(reporting_year = year)

# Survey years
dt_survey_old <- pipr::get_stats(povline = pl) |>
  qDT()
dt_survey_new <- load_from_repo("syears.fst")
dt_survey_old <- dt_survey_old |>
  frename(reporting_year = year)

# aggregates
dt_lineup_old <- pipr::get_stats(povline = pl,
                                 fill_gaps = TRUE) |>
  qDT()
dt_lineup_old <- dt_lineup_old |>
  frename(reporting_year = year)
dt_lineup_new <- load_from_repo("lyears.fst")

# dt_agg_old    <- read_fst(path = here::here("data", "use", "dt_agg_old.fst"))
# dt_agg_new    <- read_fst(path = here::here("data", "use", "dt_agg_new.fst"))
# dt_survey_old <- read_fst(path = here::here("data", "use", "dt_survey_old.fst"))
# dt_survey_new <- read_fst(path = here::here("data", "use", "dt_survey_new.fst"))
# dt_lineup_old <- read_fst(path = here::here("data", "use", "dt_lineup_old.fst"))
# dt_lineup_new <- read_fst(path = here::here("data", "use", "dt_lineup_new.fst"))
# 
# dt_agg_old    <- qDT(dt_agg_old)
# dt_agg_new    <- qDT(dt_agg_new)
# dt_survey_old <- qDT(dt_survey_old)
# dt_survey_new <- qDT(dt_survey_new)
# dt_lineup_old <- qDT(dt_lineup_old)
# dt_lineup_new <- qDT(dt_lineup_new)

```


```{r survey-data-wrangling}
# Indicator names
survey_indicators    <- dt_survey_new |> 
  fselect(headcount:decile10, spl, spr) |> 
  colnames()


# Merging OLD and NEW data
# surveys_merged <- joyn::joyn(x             = dt_survey_new,
#                               y             = dt_survey_old,
#                               by            = c("country_code",
#                                                 "reporting_year",
#                                                 "welfare_type",
#                                                 "poverty_line",
#                                                 "reporting_level"),
#                               match_type    = "1:1",
#                               keep          = "full",
#                               update_values = FALSE,
#                               all           = FALSE,
#                               verbose       = FALSE,
#                               y_vars_to_keep = TRUE,
#                               suffixes = c(".x", ".y"),
#                               keep_common_vars = TRUE)

surveys_merged <- join(x             = dt_survey_new,
                              y             = dt_survey_old,
                              on            = c("country_code",
                                                "reporting_year",
                                                "welfare_type",
                                                "poverty_line",
                                                "reporting_level"),
                              #match_type    = "1:1",
                              how          = "full",
                              #update_values = FALSE,
                              #all           = FALSE,
                              verbose       = FALSE,
                              #y_vars_to_keep = TRUE,
                              suffix = c(".x", ".y"),
                              column = list(".joyn", c("x", "y", "x & y"))
                              #keep_common_vars = TRUE
                       )



names_x <- paste0(survey_indicators, ".x")
names_y <- paste0(survey_indicators, ".y")

# Calculate the differences and assign them to new columns
surveys_merged[, 
               (paste0(survey_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
surveys_merged[, 
               (paste0(survey_indicators, "_perc")) := map2(mget(paste0(survey_indicators, "_diff")), 
                                                            mget(names_y), `/`)]
# Ratio
surveys_merged[, 
               (paste0(survey_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


```



```{r lineup-data-wrangling}
# Indicator names
lineup_indicators    <- dt_lineup_new |> 
  fselect(headcount:decile10, spl, spr) |> 
  colnames()


# Merging OLD and NEW data
lineups_merged <- joyn::joyn(x             = dt_lineup_new,
                              y             = dt_lineup_old,
                              by            = c("country_code",
                                                "reporting_year",
                                                "welfare_type",
                                                "poverty_line",
                                                "reporting_level"),
                              match_type    = "1:1",
                              keep          = "full",
                              update_values = FALSE,
                              all           = FALSE,
                              verbose       = FALSE,
                              y_vars_to_keep = TRUE,
                              suffixes = c(".x", ".y"),
                              keep_common_vars = TRUE)
# 
# lineups_merged <- join(x             = dt_lineup_new,
#                               y             = dt_lineup_old,
#                               on            = c("country_code",
#                                                 "reporting_year",
#                                                 "welfare_type",
#                                                 "poverty_line",
#                                                 "reporting_level"),
#                               #match_type    = "1:1",
#                               how          = "full",
#                               #update_values = FALSE,
#                               #all           = FALSE,
#                               verbose       = FALSE,
#                               #y_vars_to_keep = TRUE,
#                               suffix = c(".x", ".y"),
#                               column = list(".joyn", c("x", "y", "x & y"))
#                               #keep_common_vars = TRUE
#                        )


names_x <- paste0(lineup_indicators, ".x")
names_y <- paste0(lineup_indicators, ".y")

# if zero, reassign to being very small
lineups_merged[, 
   (paste0(names_x)) := lapply(.SD, 
                               function(x) {pmax(x, 0.000001)}), 
   .SDcols = names_x]
lineups_merged[, 
   (paste0(names_y)) := lapply(.SD, 
                               function(x) {pmax(x, 0.000001)}), 
   .SDcols = names_y]


# Calculate the differences and assign them to new columns
lineups_merged[, 
               (paste0(lineup_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
lineups_merged[, 
               (paste0(lineup_indicators, "_perc")) := map2(mget(paste0(lineup_indicators, "_diff")), 
                                                            mget(names_y), `/`)]
# Ratio
lineups_merged[, 
               (paste0(lineup_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


# Outlier
amnt <- 2 # SD
lineups_merged[, 
   (paste0(lineup_indicators, "_thresh_low")) := lapply(.SD, 
                                          function(x) {
                                            mn <- mean(x, na.rm = T, trim = 0.01)
                                            s  <- sd(x[x > quantile(x, 
                                                                    0.01, 
                                                                    na.rm = T) & 
                                                         x < quantile(x, 
                                                                      0.99, 
                                                                      na.rm = T)], 
                                                     na.rm = T)
                                            mn - amnt*s
                                          }),  
   .SDcols = paste0(lineup_indicators, "_ratio")]

lineups_merged[, 
   (paste0(lineup_indicators, "_thresh_high")) := lapply(.SD, 
                                          function(x) {
                                            mn <- mean(x, na.rm = T, trim = 0.01)
                                            s  <- sd(x[x > quantile(x, 
                                                                    0.01, 
                                                                    na.rm = T) & 
                                                         x < quantile(x, 
                                                                      0.99, 
                                                                      na.rm = T)], 
                                                     na.rm = T)
                                            mn + amnt*s
                                          }), 
   .SDcols = paste0(lineup_indicators, "_ratio")]



# 
# lineups_merged[,
#                (paste0(lineup_indicators, "_thresh_low")) := (mean(lineups_merged$new_old, na.rm = TRUE) -
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE),
#                       thres_new_old_hi = mean(lineups_merged$new_old, na.rm = TRUE) +
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE))]
# 
# 
# 
# lineups_merged[,
#                  `:=`(thres_new_old_lo = mean(lineups_merged$new_old, na.rm = TRUE) -
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE),
#                       thres_new_old_hi = mean(lineups_merged$new_old, na.rm = TRUE) +
#                           amnt * sd(lineups_merged$new_old, na.rm = TRUE))]

#
#   if (input$lineup_outlier_yes == "Yes") {
#       lineup_indicator[,
#                  new_old_out := !(new_old < thres_new_old_hi &
#                                     new_old > thres_new_old_lo)]
#   } else {
#           lineup_indicator[,
#                  new_old_out := (new_old < thres_new_old_hi &
#                                     new_old > thres_new_old_lo)]
#   }
#
#   lineup_indicator <- lineup_indicator[new_old_out == TRUE]
#
#   lineup_indicator <- lineup_indicator |>
#     fmutate(New = get(paste0(ind, ".x"))*100) |>
#     fmutate(Old = get(paste0(ind, ".y"))*100) |>
#     fselect("country_code", "reporting_year", "welfare_type", "Old", "New")
#
#   setnames(lineup_indicator,
#            old = c("Old", "New"),
#            new = c(paste0(c("Old_", "New_"), ind)))
# 
#  lineup_indicator
```

Trends: Old vs New
===========================================================


Column {data-width=100}
-----------------------------------------------------------------------
```{r sidebar-plot-trends-123}
# Select Indicator
shiny::selectInput("trends_indicator",
            label = "Compare indicator",
            choices = survey_indicators,
            selected = "mean")


# Select countries
shiny::selectInput("trend_country",
            label = "Economies",
            choices = c(surveys_merged$country_code |> funique()),
            selected = "ARE",
            multiple = FALSE)
```

Column {data-width=2400}
-----------------------------------------------------------------------

### Surveys



```{r}
ind <- reactive({
  input$trends_indicator
})
# country 
ct <- reactive({
  input$trend_country
})
# reactive table for trends
TT <- reactive({
  surveys_merged[country_code == ct()
                 ][, 
                   `:=`(
                       yx = get(paste0(ind(), ".x")),
                       yy = get(paste0(ind(), ".y"))
                     ) ][, 
                         text :=  paste0(
                        "Economy: ", country_code, "\n",
                        "Region: ", region_name.x, "\n",
                        "New Value:", round(yx, 4), "\n",
                        "Old Value:", round(yy, 4), "\n",
                        "Year: ", reporting_year)
                        ] 
})

renderPlotly({

  g <- ggplot(data = TT(), 
              aes(x = reporting_year, 
                  label = text)) +
    geom_line(aes(y = yx, color = "New")) + #, color = 'darkgreen') +
    geom_point(aes(y = yx, color = "New")) + #, color = 'darkgreen') +
    geom_line(aes(y = yy, color = "Old")) + #,, color = 'coral') +
    geom_point(aes(y = yy, color = "Old")) + #,, color = 'coral') +
     scale_color_manual(values = c("New" = "darkgreen", 
                                   "Old" = "coral")) +
    theme_classic() +
    labs(title = 
           paste0("Compare survey trends in indicators of 
                  new and old data for ", ct()) ,
         x     = "Reporting Year",
         y     = stringr::str_to_title(paste0(ind())))

    # ggplotly(g, tooltip = "text")
    ggplotly(g, tooltip = c("label"))

})
```

