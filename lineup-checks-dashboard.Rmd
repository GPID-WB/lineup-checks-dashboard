---
title: "Lineup Checks"
output:
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: yeti
    orientation: columns
    social: menu
    vertical_layout: scroll
runtime: shiny
---


```{r global, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(purrr)
library(fst)
library(joyn)
library(fastverse)
library(shiny)

source("R/utils.R")
pl <- 2.15

# Aggregates
dt_agg_old <- pipr::get_wb(povline = pl) |>
  qDT()
dt_agg_new <- load_from_repo("aggregates.fst")
dt_agg_old <- dt_agg_old |>
  frename(reporting_year = year)

# Survey years
dt_survey_old <- pipr::get_stats(povline = pl) |>
  qDT()
dt_survey_new <- load_from_repo("syears.fst")
dt_survey_old <- dt_survey_old |>
  frename(reporting_year = year)

# aggregates
dt_lineup_old <- pipr::get_stats(povline = pl,
                                 fill_gaps = TRUE) |>
  qDT()
dt_lineup_old <- dt_lineup_old |>
  frename(reporting_year = year)
dt_lineup_new <- load_from_repo("lyears.fst")


# survey data ---------------------
# Indicator names
survey_indicators    <- dt_survey_new |>
  fselect(headcount:decile10, spl, spr) |>
  colnames()


# Merging OLD and NEW data
surveys_merged <- joyn::joyn(
  x             = dt_survey_new,
  y             = dt_survey_old,
  by            = c(
    "country_code",
    "reporting_year",
    "welfare_type",
    "poverty_line",
    "reporting_level"
  ),
  match_type    = "1:1",
  keep          = "full",
  update_values = FALSE,
  all           = FALSE,
  verbose       = FALSE,
  y_vars_to_keep = TRUE,
  suffixes = c(".x", ".y"),
  keep_common_vars = TRUE
)

names_x <- paste0(survey_indicators, ".x")
names_y <- paste0(survey_indicators, ".y")

# Calculate the differences and assign them to new columns
surveys_merged[,
               (paste0(survey_indicators, "_diff")) := map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
surveys_merged[,
               (paste0(survey_indicators, "_perc")) := map2(mget(paste0(survey_indicators, "_diff")),
                                                            mget(names_y), `/`)]
# Ratio
surveys_merged[,
               (paste0(survey_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]

# Line up year -------------
# Indicator names
lineup_indicators    <- dt_lineup_new |>
  fselect(headcount:decile10, spl, spr) |>
  colnames()


# Merging OLD and NEW data
lineups_merged <- joyn::joyn(
  x             = dt_lineup_new,
  y             = dt_lineup_old,
  by            = c(
    "country_code",
    "reporting_year",
    "welfare_type",
    "poverty_line",
    "reporting_level"
  ),
  match_type    = "1:1",
  keep          = "full",
  update_values = FALSE,
  all           = FALSE,
  verbose       = FALSE,
  y_vars_to_keep = TRUE,
  suffixes = c(".x", ".y"),
  keep_common_vars = TRUE
)

names_x <- paste0(lineup_indicators, ".x")
names_y <- paste0(lineup_indicators, ".y")

# if zero, reassign to being very small
lineups_merged[,
               (paste0(names_x)) := lapply(.SD,
                                           function(x) {
                                             pmax(x, 0.000001)
                                           }),
               .SDcols = names_x]
lineups_merged[,
               (paste0(names_y)) := lapply(.SD,
                                           function(x) {
                                             pmax(x, 0.000001)
                                           }),
               .SDcols = names_y]


# Calculate the differences and assign them to new columns
lineups_merged[,
               (paste0(lineup_indicators, "_diff")) :=
                 map2(mget(names_x), mget(names_y), `-`)]
# Percentage of old
lineups_merged[,
               (paste0(lineup_indicators, "_perc")) :=
                 map2(mget(paste0(lineup_indicators, "_diff")),
                      mget(names_y), `/`)]
# Ratio
lineups_merged[,
               (paste0(lineup_indicators, "_ratio")) := map2(mget(names_x), mget(names_y), `/`)]


# Outlier
amnt <- 2 # SD
lineups_merged[,
               (paste0(lineup_indicators, "_thresh_low")) :=
                 lapply(.SD,
                        function(x) {
                          mn <- mean(x, na.rm = T, trim = 0.01)
                          s  <-
                            sd(x[x > quantile(x,
                                              0.01,
                                              na.rm = T) &
                                   x < quantile(x,
                                                0.99,
                                                na.rm = T)],
                               na.rm = T)
                          mn - amnt * s
                        }),
               .SDcols = paste0(lineup_indicators, "_ratio")]

lineups_merged[,
               (paste0(lineup_indicators, "_thresh_high")) :=
                 lapply(.SD,
                        function(x) {
                          mn <- mean(x, na.rm = T, trim = 0.01)
                          s  <-
                            sd(x[x > quantile(x,
                                              0.01,
                                              na.rm = T) &
                                   x < quantile(x,
                                                0.99,
                                                na.rm = T)],
                               na.rm = T)
                          mn + amnt * s
                        }),
               .SDcols = paste0(lineup_indicators, "_ratio")]

countries_available <- 
  surveys_merged$country_code |> 
  funique()
```


Trends: Old vs New
===========================================================


Column {.sidebar}
-----------------------------------------------------------------------
```{r sidebar-plot-trends-123}
# Select Indicator
selectInput("trends_indicator", 
            label = "Compare indicator",
            choices = survey_indicators,
            selected = "mean")


# Select countries
selectInput("trend_country",
            label = "Economies",
            choices = countries_available,
            selected = "ARE",
            multiple = FALSE)
```

```{r trends-reactive}
ind <- reactive({
  input$trends_indicator
})
# country 
ct <- reactive({
  input$trend_country
})
# reactive table for trends
ST <- reactive({
  surveys_merged[country_code == ct()
                 ][, 
                   `:=`(
                       yx = get(paste0(ind(), ".x")),
                       yy = get(paste0(ind(), ".y"))
                     ) ][, 
                         text :=  paste0(
                        "Economy: ", country_code, "\n",
                        "Region: ", region_name.x, "\n",
                        "New Value:", round(yx, 4), "\n",
                        "Old Value:", round(yy, 4), "\n",
                        "Year: ", reporting_year)
                        ] 
})

LT <- reactive({
  lineups_merged[country_code == ct()
                 ][, 
                   `:=`(
                       yx = get(paste0(ind(), ".x")),
                       yy = get(paste0(ind(), ".y"))
                     ) ][, 
                         text :=  paste0(
                        "Economy: ", country_code, "\n",
                        "Region: ", region_name.x, "\n",
                        "New Value:", round(yx, 4), "\n",
                        "Old Value:", round(yy, 4), "\n",
                        "Year: ", reporting_year)
                        ] 
})
```

Column
-----------------------------------------------------------------------

### Survey Years

```{r trends-svy}
renderPlotly({

  g_trends(dt = ST(), country = ct(), indicator = ind())

})
```

Column
-----------------------------------------------------------------------

### Lineups

```{r trends-lny}
renderPlotly({
  
  g_trends(dt = LT(), country = ct(), indicator = ind())
  
})
```


Survey years
===========================================================


Column {.sidebar}
-----------------------------------------------------------------------
```{r sidebar-plot-survey-3}
# Select Indicator
selectInput("survey_indicator",
            label = "Compare indicator:",
            choices = survey_indicators,
            selected = "headcount")

# Select countries
selectInput("survey_country",
            label = "Economies:",
            choices = c("All", countries_available),
            selected = "All",
            multiple = TRUE)


# Select countries
selectInput("survey_percentage",
            label = "Percentage (i.t.o old) or real difference:",
            choices = c("Percentage change", "Real difference", "Ratio"),
            selected = "Percentage change",
            multiple = FALSE)


# Select countries
numericInput(
  "survey_outlier",
  label = "Outlier detection - sd threshold",
  value = 2,
  min   = 0,
  max   = 5,
  step = 0.1,
  width = NULL
)

selectInput(
  "survey_outlier_yes",
  label = "Is outlier",
  choices = c("Yes", "No"),
  selected = "Yes",
  multiple = FALSE
)

```

```{r survey-data-reactive}
svy_ind <- reactive({
  input$survey_indicator
})

svy_ct <- reactive({
  input$survey_country
})

svy_chg <- reactive({
  input$survey_percentage
})

survey_indicator <- reactive({

  # Copy data table
  survey_indicator <- copy(surveys_merged)
  
  if (!svy_chg() == "Ratio") {
    if (svy_chg() == "Percentage change") {
      # indicator
      setnames(survey_indicator,
               old = (paste0(svy_ind(), "_perc")),
               new = "New_minus_old")
      
    } else {
      # indicator
      setnames(survey_indicator,
               old = (paste0(svy_ind(), "_diff")),
               new = "New_minus_old")
    }
  } else {
    setnames(survey_indicator,
             old = (paste0(svy_ind(), "_ratio")),
             new = "New_minus_old")
  }
  
  if (!"All" %chin% svy_ct()) {
    survey_indicator <- survey_indicator |>
      fsubset(country_code %in% svy_ct())
  }
  
  # Tooltip
  survey_indicator[,
                   text_tooltip :=
                     paste0(
                       "Economy: ", country_code,"\n",
                       "Region: ", region_name.x, "\n",
                       "Value: ", round(New_minus_old, 4),"\n",
                       "Year: ", reporting_year
                     )]
  
  survey_indicator
  
})

survey_baltman <- reactive({
  # Copy data table
  survey_indicator <- surveys_merged
  ind <- paste(input$survey_indicator)
  
  if (!"All" %chin% input$survey_country) {
    survey_indicator <- survey_indicator |>
      fsubset(country_code %in% input$survey_country)
  }
  survey_indicator[,
                   `:=`(diff = get(paste0(ind, ".x")) -
                          get(paste0(ind, ".y")),
                        mean_btw = (get(paste0(ind, ".x")) +
                                      get(paste0(ind, ".y"))) / 2)]
  # Tooltip
  survey_indicator[,
                   text_tooltip :=
                     paste0(
                       "Economy: ", country_code,"\n",
                       "Region: ", region_name.x, "\n",
                       "Mean old and new: ",round(mean_btw, 4),"\n",
                       "Difference: ",round(diff, 4),"\n",
                       "Year: ",reporting_year
                     )]
  survey_indicator
  
})

survey_outlier <- reactive({
  # standard dev
  amnt <- input$survey_outlier
  # Copy data table
  survey_indicator <- surveys_merged
  ind <- paste(input$survey_indicator)
  
  # Define low and high thresholds
  surveys_merged[, new_old := get(paste0(ind, ".x")) / get(paste0(ind, ".y"))]
  surveys_merged[,
                 `:=`(
                   thres_new_old_lo = mean(surveys_merged$new_old, na.rm = TRUE) -
                     2 * sd(surveys_merged$new_old, na.rm = TRUE),
                   thres_new_old_hi = mean(surveys_merged$new_old, na.rm = TRUE) +
                     2 * sd(surveys_merged$new_old, na.rm = TRUE)
                 )]
  
  # Inside or outside threshold
  if (input$survey_outlier_yes == "Yes") {
    surveys_merged[,
                   new_old_out := !(new_old < thres_new_old_hi &
                                      new_old > thres_new_old_lo)]
  } else {
    surveys_merged[,
                   new_old_out := (new_old < thres_new_old_hi &
                                     new_old > thres_new_old_lo)]
  }
  
  surveys_merged <- surveys_merged[new_old_out == TRUE]
  
  surveys_merged <- surveys_merged |>
    fmutate(New = get(paste0(ind, ".x")) * 100) |>
    fmutate(Old = get(paste0(ind, ".y")) * 100) |>
    fselect("country_code",
            "reporting_year",
            "welfare_type",
            "Old",
            "New")
  
  setnames(surveys_merged,
           old = c("Old", "New"),
           new = c(paste0(c("Old_", "New_"), ind)))
  
  surveys_merged
  
  
})

```


Column {.tabset data-width=600} 
-----------------------------------------------------------------------

### Difference over time 


```{r plot-survey}
renderPlotly({
   
  g <- ggplot(data = survey_indicator(), 
              aes(x      = reporting_year,
                  y      = New_minus_old,
                  colour = region_code.x,
                  group  = country_code)) +
          geom_point(aes(text = text_tooltip)) +
          geom_line() +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "New Vs old",
         x     = "Reporting Year",
         y     = paste0("Difference in ",
                        svy_ind(),
                        ifelse(grepl("[Pp]ercentage", input$survey_percentage), 
                               " %", ""),
                        " (new minus old)"))

  g <- ggplotly(g, tooltip = "text")

  g

})

```

### Scatterplot of old vs new estimates

```{r}
renderPlotly({
  

  g <- ggplot(data = survey_indicator(),
              aes(x = get(paste0(svy_ind(), ".y")),
                  y = get(paste0(svy_ind(), ".x")),
                  color = region_code.x,
                  group = country_code)) +
    geom_point(aes(text = text_tooltip)) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", alpha = 0.3) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Scatter plot new survey estimate minus old",
         x     = paste("Old", svy_ind()),
         y     = paste("New", svy_ind()))

  g <- ggplotly(g, tooltip = "text")

  g
})
```


### Bland-Altman plot

```{r}
renderPlotly({


  g <- ggplot(data = survey_baltman(),
              aes(x = mean_btw,
                  y = diff,
                  color = region_code.x)) +
        geom_point(aes(text = text_tooltip)) +
    theme_classic() +
    scale_color_brewer(palette = "Dark2") +
    labs(title = "Bland-Altman Plot",
         x     = paste("Mean of old and new", svy_ind()),
         y     = paste("Difference between old and new", svy_ind()))

  g <- ggplotly(g, tooltip = "text")

  g
})
```



Column {data-width=400}
-----------------------------------------------------------------------

### Table of outliers


```{r}
renderTable({
  survey_outlier()
})

```


